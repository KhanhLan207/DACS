@model TicketBus.Models.BusRoute

@{
    ViewData["Title"] = "Chi tiết tuyến xe";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";

    // Ánh xạ enum sang tên hiển thị
    var stateNames = new Dictionary<BusRouteState, string>
    {
        { BusRouteState.ChoPheDuyet, "Chờ phê duyệt" },
        { BusRouteState.DaPheDuyet, "Đã phê duyệt" },
        { BusRouteState.TuChoi, "Từ chối" },
        { BusRouteState.KhongHoatDong, "Không hoạt động" }
    };
}

<h2>Chi tiết tuyến xe</h2>

<div class="card">
    <div class="card-header">
        <h4>Thông tin tuyến xe</h4>
    </div>
    <div class="card-body">
        <dl class="row">
            <dt class="col-sm-3">Mã tuyến</dt>
            <dd class="col-sm-9">@Model.RouteCode</dd>

            <dt class="col-sm-3">Tên tuyến</dt>
            <dd class="col-sm-9">@Model.NameRoute</dd>

            <dt class="col-sm-3">Địa chỉ tuyến</dt>
            <dd class="col-sm-9">@Model.Address</dd>

            <dt class="col-sm-3">Khoảng cách</dt>
            <dd class="col-sm-9">@Model.Distance km</dd>

            <dt class="col-sm-3">Hãng xe</dt>
            <dd class="col-sm-9">@(Model.Brand?.NameBrand ?? "Chưa xác định")</dd>

            <dt class="col-sm-3">Thành phố xuất phát</dt>
            <dd class="col-sm-9">@(Model.StartCity?.NameCity ?? "Chưa xác định")</dd>

            <dt class="col-sm-3">Thành phố kết thúc</dt>
            <dd class="col-sm-9">@(Model.EndCity?.NameCity ?? "Chưa xác định")</dd>

            <dt class="col-sm-3">Thời gian hành trình</dt>
            <dd class="col-sm-9">@(Model.TravelTime.HasValue ? Model.TravelTime.Value.ToString(@"hh\:mm") : "Chưa xác định")</dd>

            <dt class="col-sm-3">Giờ xuất bến</dt>
            <dd class="col-sm-9">
                @if (Model.DepartureTimes != null && Model.DepartureTimes.Any())
                {
                    @string.Join(", ", Model.DepartureTimes.Select(t => t.ToString(@"hh\:mm")))
                }
                else
                {
                    @: Chưa xác định
                }
            </dd>

            <dt class="col-sm-3">Ngày bắt đầu</dt>
            <dd class="col-sm-9">@(Model.StartDate.HasValue ? Model.StartDate.Value.ToString("dd/MM/yyyy") : "Chưa xác định")</dd>

            <dt class="col-sm-3">Trạng thái</dt>
            <dd class="col-sm-9">@stateNames[Model.State]</dd>
        </dl>
    </div>
</div>

<h4 class="mt-4">Danh sách điểm dừng</h4>
@if (Model.RouteStops == null || !Model.RouteStops.Any())
{
    <div class="alert alert-warning">Không có điểm dừng nào.</div>
}
else
{
    <table class="table table-bordered table-striped">
        <thead class="thead-dark">
            <tr>
                <th>Thứ tự</th>
                <th>Mã điểm dừng</th>
                <th>Tên điểm dừng</th>
                <th>Thành phố</th>
                <th>Thời gian</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var stop in Model.RouteStops.OrderBy(s => s.StopOrder))
            {
                <tr>
                    <td>@stop.StopOrder</td>
                    <td>@stop.StopCode</td>
                    <td>@(stop.StopName ?? "Không có tên")</td>
                    <td>@(stop.City?.NameCity ?? "Chưa xác định")</td>
                    <td>@(stop.Time.HasValue ? stop.Time.Value.ToString(@"hh\:mm") : "Chưa xác định")</td>
                </tr>
            }
        </tbody>
    </table>
}

<div class="mt-3">
    @if (Model.State == BusRouteState.ChoPheDuyet)
    {
        <form asp-action="Approve" asp-route-id="@Model.IdRoute" method="post" class="d-inline">
            @Html.AntiForgeryToken()
            <input type="hidden" name="reason" value="Phê duyệt bởi Admin" />
            <button type="submit" class="btn btn-success" onclick="return confirm('Bạn có chắc muốn phê duyệt tuyến xe này?')">Phê duyệt</button>
        </form>
        <form asp-action="Reject" asp-route-id="@Model.IdRoute" method="post" class="d-inline">
            @Html.AntiForgeryToken()
            <input type="hidden" name="reason" value="Từ chối bởi Admin" />
            <button type="submit" class="btn btn-danger" onclick="return confirm('Bạn có chắc muốn từ chối tuyến xe này?')">Từ chối</button>
        </form>
    }
    <a asp-action="PendingApproval" asp-route-filter="pending" class="btn btn-secondary">Quay lại danh sách</a>
</div>