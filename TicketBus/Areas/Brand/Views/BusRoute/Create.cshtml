@model TicketBus.Models.ViewModels.BusRouteViewModel

@{
    ViewData["Title"] = "Đăng ký tuyến xe mới";
    Layout = "~/Areas/Brand/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/CreateBusRoute.css" asp-append-version="true" />

<h2>Đăng ký tuyến xe mới</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<form asp-action="Create" method="post" id="createForm">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div class="form-group mb-3">
        <label asp-for="NameRoute" class="control-label">Tên tuyến</label>
        <input asp-for="NameRoute" class="form-control" />
        <span asp-validation-for="NameRoute" class="text-danger"></span>
    </div>

    <div class="form-group mb-3">
        <label asp-for="Address" class="control-label">Địa chỉ tuyến</label>
        <input asp-for="Address" class="form-control" />
        <span asp-validation-for="Address" class="text-danger"></span>
    </div>

    <div class="form-group mb-3">
        <label asp-for="Distance" class="control-label">Khoảng cách (km)</label>
        <input asp-for="Distance" class="form-control" type="number" min="1" />
        <span asp-validation-for="Distance" class="text-danger"></span>
    </div>

    <div class="form-group mb-3">
        <label asp-for="IdBrand" class="control-label">Hãng xe</label>
        <select asp-for="IdBrand" asp-items="Model.Brands" class="form-control">
            <option value="">Chọn hãng xe</option>
        </select>
        <span asp-validation-for="IdBrand" class="text-danger"></span>
    </div>

    <div class="form-group mb-3">
        <label asp-for="IdStartCity" class="control-label">Thành phố xuất phát</label>
        <select asp-for="IdStartCity" asp-items="Model.Cities" class="form-control">
            <option value="">Chọn thành phố</option>
        </select>
        <span asp-validation-for="IdStartCity" class="text-danger"></span>
    </div>

    <div class="form-group mb-3">
        <label asp-for="IdEndCity" class="control-label">Thành phố kết thúc</label>
        <select asp-for="IdEndCity" asp-items="Model.Cities" class="form-control">
            <option value="">Chọn thành phố</option>
        </select>
        <span asp-validation-for="IdEndCity" class="text-danger"></span>
    </div>

    <div class="form-group mb-3">
        <label asp-for="TravelTime" class="control-label">Thời gian hành trình (HH:mm)</label>
        <input asp-for="TravelTime" class="form-control" placeholder="07:00" />
        <span asp-validation-for="TravelTime" class="text-danger"></span>
    </div>

    <div class="form-group mb-3">
        <label asp-for="DepartureTimes" class="control-label">Giờ xuất bến (HH:mm)</label>
        <div id="departure-times">
            @for (int i = 0; i < Model.DepartureTimes.Count; i++)
            {
                <div class="departure-time-entry mb-2 d-flex align-items-center">
                    <input type="text" name="DepartureTimes[@i]" class="form-control me-2" placeholder="08:00" value="@Model.DepartureTimes[i]" required pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$" style="width: 100px;" />
                    <a href="#" class="remove-departure-time text-danger">Xóa</a>
                    <span class="text-danger field-validation-error ms-2" data-valmsg-for="DepartureTimes[@i]" data-valmsg-replace="true"></span>
                </div>
            }
        </div>
        <button type="submit" asp-action="AddDepartureTime" class="btn btn-secondary mt-2">Thêm giờ xuất bến</button>
        <span asp-validation-for="DepartureTimes" class="text-danger"></span>
    </div>

    <div class="form-group mb-3">
        <label asp-for="StartDate" class="control-label">Ngày bắt đầu hoạt động</label>
        <input asp-for="StartDate" class="form-control" type="date" />
        <span asp-validation-for="StartDate" class="text-danger"></span>
    </div>

    <h4 class="mt-4">Điểm dừng</h4>
    <div id="route-stops">
        @for (int i = 0; i < Model.RouteStops.Count; i++)
        {
            <div class="form-group route-stop p-3 mb-3 border rounded" data-index="@i">
                <h5>Điểm dừng @(i + 1)</h5>
                <input type="hidden" asp-for="RouteStops[i].StopOrder" />
                <div class="form-group">
                    <label asp-for="RouteStops[i].StopName" class="control-label">Tên điểm dừng</label>
                    <input asp-for="RouteStops[i].StopName" class="form-control" id="@($"RouteStops_{i}_StopName")" />
                    <span asp-validation-for="RouteStops[i].StopName" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="RouteStops[i].IdCity" class="control-label">Thành phố</label>
                    <select asp-for="RouteStops[i].IdCity" asp-items="Model.RouteStops[i].Cities" class="form-control stop-city-select" id="@($"RouteStops_{i}_IdCity")"></select>
                    <span asp-validation-for="RouteStops[i].IdCity" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="RouteStops[i].Time" class="control-label">Thời gian (HH:mm)</label>
                    <input asp-for="RouteStops[i].Time" class="form-control" placeholder="14:30" id="@($"RouteStops_{i}_Time")" />
                    <span asp-validation-for="RouteStops[i].Time" class="text-danger"></span>
                </div>
                <button type="button" class="btn btn-danger remove-route-stop">Xóa điểm dừng</button>
            </div>
        }
    </div>
    <button type="submit" asp-action="AddRouteStop" class="btn btn-secondary mb-3">Thêm điểm dừng</button>

    <div class="form-group mt-3">
        <input type="submit" value="Đăng ký" class="btn btn-primary" />
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Xử lý xóa giờ xuất bến
            $(document).on('click', '.remove-departure-time', function (e) {
                e.preventDefault();
                $(this).closest('.departure-time-entry').remove();
                $('#departure-times .departure-time-entry').each(function (index) {
                    $(this).find('input').attr('name', `DepartureTimes[${index}]`);
                    $(this).find('span').attr('data-valmsg-for', `DepartureTimes[${index}]`);
                });
            });

            // Xử lý xóa điểm dừng
            $(document).on('click', '.remove-route-stop', function () {
                $(this).closest('.route-stop').remove();
                $('#route-stops .route-stop').each(function (index) {
                    $(this).attr('data-index', index);
                    $(this).find('h5').text(`Điểm dừng ${index + 1}`);
                    $(this).find('input[type="hidden"]').attr('name', `RouteStops[${index}].StopOrder`).val(index);
                    $(this).find('input[name$="StopName"]').attr('name', `RouteStops[${index}].StopName`).attr('id', `RouteStops_${index}_StopName`);
                    $(this).find('select[name$="IdCity"]').attr('name', `RouteStops[${index}].IdCity`).attr('id', `RouteStops_${index}_IdCity`);
                    $(this).find('input[name$="Time"]').attr('name', `RouteStops[${index}].Time`).attr('id', `RouteStops_${index}_Time`);
                    $(this).find('span[data-valmsg-for$="StopName"]').attr('data-valmsg-for', `RouteStops[${index}].StopName`);
                    $(this).find('span[data-valmsg-for$="IdCity"]').attr('data-valmsg-for', `RouteStops[${index}].IdCity`);
                    $(this).find('span[data-valmsg-for$="Time"]').attr('data-valmsg-for', `RouteStops[${index}].Time`);
                });
            });

            // Kiểm tra số lượng điểm dừng trước khi submit
            $('#createForm').on('submit', function (e) {
                const routeStops = document.querySelectorAll('.route-stop');
                if (routeStops.length < 2) {
                    e.preventDefault();
                    alert('Tuyến xe phải có ít nhất 2 điểm dừng (điểm bắt đầu và điểm kết thúc).');
                    return false;
                }
            });
        });
    </script>
}