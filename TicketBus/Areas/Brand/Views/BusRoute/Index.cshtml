@model IEnumerable<TicketBus.Models.BusRoute>

@{
    ViewData["Title"] = "Danh sách tuyến xe";
    Layout = "~/Areas/Brand/Views/Shared/_Layout.cshtml"; // Chỉ định layout của Brand
}

<div class="brand-main">
    <div class="brand-content">
        <h1 class="mt-4">Danh sách tuyến xe</h1>
        <ol class="breadcrumb mb-4">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index" asp-area="Brand">Quay lại</a></li>
            <li class="breadcrumb-item active">Danh sách tuyến xe</li>
        </ol>

        <!-- Hiển thị thông báo từ TempData -->
        @if (TempData["Message"] != null)
        {
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                @TempData["Message"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (Model.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-table me-1"></i>
                    Danh sách tuyến xe đã được phê duyệt
                </div>
                <div class="card-body">
                    <table id="datatablesSimple" class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Tên tuyến</th>
                                <th>Địa chỉ</th>
                                <th>Quận/Huyện</th>
                                <th>Khoảng cách (km)</th>
                                <th>Hãng xe</th>
                                <th>Thành phố xuất phát</th>
                                <th>Thành phố kết thúc</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th> <!-- Thêm cột Hành động -->
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                // Kiểm tra RouteStops có tồn tại và không rỗng
                                var firstStop = item.RouteStops?.OrderBy(s => s.StopOrder).FirstOrDefault();
                                var lastStop = item.RouteStops?.OrderBy(s => s.StopOrder).LastOrDefault();

                                // Lấy tên Quận/Huyện từ ViewBag.Districts
                                var districts = ViewBag.Districts as Dictionary<int, string>;
                                var firstDistrict = firstStop?.IdDistrict != null && districts?.ContainsKey(firstStop.IdDistrict.Value) == true
                                ? districts[firstStop.IdDistrict.Value]
                                : "N/A";
                                var lastDistrict = lastStop?.IdDistrict != null && districts?.ContainsKey(lastStop.IdDistrict.Value) == true
                                ? districts[lastStop.IdDistrict.Value]
                                : "N/A";

                                <tr>
                                    <td>@item.NameRoute</td>
                                    <td>@(item.Address ?? "N/A")</td>
                                    <td>
                                        @(firstDistrict == lastDistrict
                                            ? firstDistrict
                                            : $"{firstDistrict} - {lastDistrict}")
                                    </td>
                                    <td>@item.Distance</td>
                                    <td>@(item.Brand != null ? item.Brand.NameBrand : "N/A")</td>
                                    <td>@(item.StartCity != null ? item.StartCity.NameCity : "N/A")</td>
                                    <td>@(item.EndCity != null ? item.EndCity.NameCity : "N/A")</td>
                                    <td>@item.State</td>
                                    <td>
                                        <a asp-action="Details" asp-route-id="@item.IdRoute" class="btn btn-info btn-sm">Xem chi tiết</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-info" role="alert">
                Không có tuyến xe nào đã được phê duyệt.
            </div>
        }

        <a asp-action="Create" class="btn btn-success">Đăng ký tuyến mới</a>
    </div>
</div>

@section Scripts {
    <script>
        // Khởi tạo simple-datatables
        window.addEventListener('DOMContentLoaded', () => {
            const dataTable = new simpleDatatables.DataTable("#datatablesSimple", {
                searchable: true,
                fixedHeight: true,
                perPage: 10
            });
        });
    </script>
}