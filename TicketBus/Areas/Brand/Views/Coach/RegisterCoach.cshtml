@model TicketBus.Areas.Brand.Controllers.CoachController.InputModel

<link rel="stylesheet" href="~/css/register-coach.css" asp-append-version="true" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />

@{
    ViewData["Title"] = "Đăng ký xe";
    var vehicleTypes = ViewBag.VehicleTypes as List<TicketBus.Models.VehicleType>;
}

<section class="register-coach-section">
    <div class="container">
        <div class="row justify-content-center align-items-center">
            <div class="col-md-10 col-lg-8">
                <div class="register-coach-container">
                    <h1 class="register-coach-title">@ViewData["Title"]</h1>

                    @if (TempData["Message"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["Message"]
                            @if (TempData["DocumentPath"] != null)
                            {
                                <div class="mt-2">
                                    Tài liệu đã upload:
                                    <a href="@TempData["DocumentPath"]" target="_blank" class="btn btn-guide">
                                        <i class="fas fa-book"></i> Xem tài liệu
                                    </a>
                                </div>
                            }
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <form asp-action="RegisterCoach" asp-controller="Coach" asp-area="Brand" method="post" enctype="multipart/form-data">
                        <h2 class="register-coach-subtitle">Thông tin đăng ký xe</h2>

                        <div asp-validation-summary="ModelOnly" class="text-danger text-center mb-4"></div>

                        <div class="row">
                            <div class="col-md-6">
                                @* Tên hãng xe *@
                                <div class="form-group mb-4">
                                    <label asp-for="BrandName" class="form-label">Tên hãng xe</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-building"></i></span>
                                        <input asp-for="BrandName" class="form-control" placeholder="Tên hãng xe" required />
                                    </div>
                                    <span asp-validation-for="BrandName" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                @* Địa chỉ hãng xe *@
                                <div class="form-group mb-4">
                                    <label asp-for="BrandAddress" class="form-label">Địa chỉ hãng xe</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                        <input asp-for="BrandAddress" class="form-control" placeholder="Địa chỉ hãng xe" required />
                                    </div>
                                    <span asp-validation-for="BrandAddress" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                @* Số điện thoại *@
                                <div class="form-group mb-4">
                                    <label asp-for="PhoneNumber" class="form-label">Số điện thoại liên hệ</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                        <input asp-for="PhoneNumber" class="form-control" placeholder="Số điện thoại liên hệ" required />
                                    </div>
                                    <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                @* Biển số xe *@
                                <div class="form-group mb-4">
                                    <label asp-for="NumberPlate" class="form-label">Biển số xe</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-car"></i></span>
                                        <input asp-for="NumberPlate" class="form-control" placeholder="Biển số xe (VD: 51B-123.45)" required />
                                    </div>
                                    <span asp-validation-for="NumberPlate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                @* Loại xe *@
                                <div class="form-group mb-4">
                                    <label asp-for="IdType" class="form-label">Loại xe</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-bus"></i></span>
                                        <select asp-for="IdType" class="form-control" id="vehicleTypeSelect" required>
                                            <option value="">-- Chọn loại xe --</option>
                                            @foreach (var vehicleType in vehicleTypes)
                                            {
                                                <option value="@vehicleType.IdType">
                                                    @vehicleType.NameType (Số ghế: @vehicleType.SeatCount)
                                                </option>
                                            }
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <span asp-validation-for="IdType" class="text-danger"></span>
                                </div>

                                @* Trường nhập liệu cho loại xe mới (ẩn mặc định) *@
                                <div id="customVehicleType" style="display: none;">
                                    <div class="form-group mb-4">
                                        <label for="CustomVehicleTypeName" class="form-label">Tên loại xe mới</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-bus"></i></span>
                                            <input type="text" name="CustomVehicleTypeName" id="CustomVehicleTypeName" class="form-control" placeholder="Nhập tên loại xe mới" />
                                        </div>
                                    </div>
                                    <div class="form-group mb-4">
                                        <label for="CustomVehicleSeatCount" class="form-label">Số ghế</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-chair"></i></span>
                                            <input type="number" name="CustomVehicleSeatCount" id="CustomVehicleSeatCount" class="form-control" placeholder="Nhập số ghế" min="1" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                @* Tình trạng xe *@
                                <div class="form-group mb-4">
                                    <label asp-for="State" class="form-label">Tình trạng xe</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-info-circle"></i></span>
                                        <select asp-for="State" class="form-control">
                                            <option value="HoatDong">Hoạt động</option>
                                            <option value="KhongHoatDong">Không hoạt động</option>
                                        </select>
                                    </div>
                                    <span asp-validation-for="State" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        @* Ảnh xe *@
                        <div class="form-group mb-4">
                            <label asp-for="ImageFile" class="form-label">Ảnh xe (tùy chọn)</label>
                            <input asp-for="ImageFile" class="form-control" type="file" accept="image/*" />
                            <span asp-validation-for="ImageFile" class="text-danger"></span>
                        </div>

                        @* Tài liệu Word/PDF *@
                        <div class="form-group mb-4">
                            <label asp-for="DocumentFile" class="form-label">Tài liệu (Word hoặc PDF, tùy chọn)</label>
                            <div class="upload-group">
                                <input asp-for="DocumentFile" class="form-control" type="file" accept=".doc,.docx,.pdf" id="documentFileInput" />
                                <div id="viewDocumentButton" style="display: none;">
                                    <a href="#" target="_blank" class="btn btn-guide" id="viewDocumentLink">
                                        <i class="fas fa-book"></i> Xem tài liệu
                                    </a>
                                </div>
                            </div>
                            <span asp-validation-for="DocumentFile" class="text-danger"></span>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-register-coach">Đăng ký xe</button>
                        </div>

                        @* Script xử lý hiển thị/ẩn custom vehicle type *@
                        <script>
                            document.addEventListener("DOMContentLoaded", function () {
                                console.log("DOM fully loaded and parsed");

                                // Xử lý hiển thị/ẩn custom vehicle type
                                var vehicleTypeSelect = document.getElementById("vehicleTypeSelect");
                                var customVehicleTypeDiv = document.getElementById("customVehicleType");
                                var customVehicleTypeName = document.getElementById("CustomVehicleTypeName");
                                var customVehicleSeatCount = document.getElementById("CustomVehicleSeatCount");

                                if (!vehicleTypeSelect || !customVehicleTypeDiv || !customVehicleTypeName || !customVehicleSeatCount) {
                                    console.error("One or more elements not found:", {
                                        vehicleTypeSelect: !!vehicleTypeSelect,
                                        customVehicleTypeDiv: !!customVehicleTypeDiv,
                                        customVehicleTypeName: !!customVehicleTypeName,
                                        customVehicleSeatCount: !!customVehicleSeatCount
                                    });
                                    return;
                                }

                                function toggleCustomVehicleType() {
                                    console.log("Vehicle Type Selected:", vehicleTypeSelect.value);
                                    if (vehicleTypeSelect.value === "other") {
                                        console.log("Showing custom vehicle type fields");
                                        customVehicleTypeDiv.style.display = "block";
                                        customVehicleTypeName.setAttribute("required", "required");
                                        customVehicleSeatCount.setAttribute("required", "required");
                                    } else {
                                        console.log("Hiding custom vehicle type fields");
                                        customVehicleTypeDiv.style.display = "none";
                                        customVehicleTypeName.removeAttribute("required");
                                        customVehicleSeatCount.removeAttribute("required");
                                    }
                                }

                                toggleCustomVehicleType();
                                vehicleTypeSelect.addEventListener("change", toggleCustomVehicleType);

                                // Xử lý upload file qua AJAX
                                var documentFileInput = document.getElementById("documentFileInput");
                                var viewDocumentButton = document.getElementById("viewDocumentButton");
                                var viewDocumentLink = document.getElementById("viewDocumentLink");

                                if (documentFileInput && viewDocumentButton && viewDocumentLink) {
                                    documentFileInput.addEventListener("change", function () {
                                        var file = this.files[0];
                                        if (!file) {
                                            viewDocumentButton.style.display = "none";
                                            return;
                                        }

                                        var formData = new FormData();
                                        formData.append("file", file);

                                        fetch("/Brand/Coach/UploadTempDocument", {
                                            method: "POST",
                                            body: formData
                                        })
                                            .then(response => response.json())
                                            .then(data => {
                                                if (data.success) {
                                                    viewDocumentLink.href = data.documentPath;
                                                    viewDocumentButton.style.display = "inline-flex";
                                                } else {
                                                    alert(data.message);
                                                    viewDocumentButton.style.display = "none";
                                                    documentFileInput.value = ""; // Xóa file đã chọn nếu upload thất bại
                                                }
                                            })
                                            .catch(error => {
                                                console.error("Error uploading file:", error);
                                                alert("Có lỗi xảy ra khi upload file. Vui lòng thử lại.");
                                                viewDocumentButton.style.display = "none";
                                                documentFileInput.value = "";
                                            });
                                    });
                                }
                            });
                        </script>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}